"""
H1ã‚¿ã‚°è‡ªå‹•è¨­å®šã‚·ã‚¹ãƒ†ãƒ 
è¨˜äº‹ã®H1ã‚¿ã‚°ãŒé©åˆ‡ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ã—ã€å¿…è¦ã«å¿œã˜ã¦ä¿®æ­£
"""

import sys
import os
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from core.wordpress_api import WordPressBlogAutomator
import requests
import re
from datetime import datetime

class H1ã‚¿ã‚°è‡ªå‹•è¨­å®šã‚·ã‚¹ãƒ†ãƒ :
    """H1ã‚¿ã‚°ã®è¨­å®šã¨æœ€é©åŒ–"""
    
    def __init__(self):
        self.wp = WordPressBlogAutomator(
            site_url="https://muffin-blog.com",
            username="muffin1203",
            password="TMLy Z4Wi RhPu oVLm 0lcO gZdi"
        )
        
        # å¯¾è±¡è¨˜äº‹ãƒªã‚¹ãƒˆ
        self.å¯¾è±¡è¨˜äº‹ãƒªã‚¹ãƒˆ = [2732, 2677, 2625, 2535, 2210]
    
    def H1ã‚¿ã‚°çŠ¶æ³ç¢ºèª(self, è¨˜äº‹ID):
        """è¨˜äº‹ã®H1ã‚¿ã‚°çŠ¶æ³ã‚’ç¢ºèª"""
        
        try:
            response = requests.get(f"{self.wp.api_url}/posts/{è¨˜äº‹ID}", headers=self.wp.headers)
            if response.status_code != 200:
                return None
            
            è¨˜äº‹ãƒ‡ãƒ¼ã‚¿ = response.json()
            è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ« = è¨˜äº‹ãƒ‡ãƒ¼ã‚¿['title']['rendered']
            è¨˜äº‹å†…å®¹ = è¨˜äº‹ãƒ‡ãƒ¼ã‚¿['content']['rendered']
            
            # H1ã‚¿ã‚°ã‚’æ¤œç´¢
            h1_matches = re.findall(r'<h1[^>]*>(.*?)</h1>', è¨˜äº‹å†…å®¹, re.IGNORECASE | re.DOTALL)
            
            çŠ¶æ³ = {
                "è¨˜äº‹ID": è¨˜äº‹ID,
                "è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«": è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«,
                "H1ã‚¿ã‚°æ•°": len(h1_matches),
                "H1ã‚¿ã‚°å†…å®¹": h1_matches,
                "è¨˜äº‹å†…å®¹": è¨˜äº‹å†…å®¹
            }
            
            return çŠ¶æ³
            
        except Exception as e:
            print(f"âŒ è¨˜äº‹ID {è¨˜äº‹ID}: ã‚¨ãƒ©ãƒ¼ - {e}")
            return None
    
    def H1ã‚¿ã‚°æœ€é©åŒ–(self, è¨˜äº‹ID):
        """H1ã‚¿ã‚°ã‚’æœ€é©åŒ–"""
        
        print(f"ğŸ·ï¸ è¨˜äº‹ID {è¨˜äº‹ID} ã®H1ã‚¿ã‚°æœ€é©åŒ–ä¸­...")
        
        çŠ¶æ³ = self.H1ã‚¿ã‚°çŠ¶æ³ç¢ºèª(è¨˜äº‹ID)
        if not çŠ¶æ³:
            return False
        
        è¨˜äº‹å†…å®¹ = çŠ¶æ³["è¨˜äº‹å†…å®¹"]
        è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ« = çŠ¶æ³["è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«"]
        
        # ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
        ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ« = f"/Users/satoumasamitsu/osigoto/ãƒ–ãƒ­ã‚°è‡ªå‹•åŒ–/backups/è¨˜äº‹{è¨˜äº‹ID}_h1_backup_{datetime.now().strftime('%Y%m%d_%H%M%S')}.html"
        os.makedirs(os.path.dirname(ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«), exist_ok=True)
        with open(ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«, 'w', encoding='utf-8') as f:
            f.write(è¨˜äº‹å†…å®¹)
        print(f"   ğŸ’¾ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¿å­˜: {os.path.basename(ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«)}")
        
        æ›´æ–°æ¸ˆã¿å†…å®¹ = è¨˜äº‹å†…å®¹
        å¤‰æ›´ãƒ•ãƒ©ã‚° = False
        
        # H1ã‚¿ã‚°ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«ã‚’H1ã¨ã—ã¦è¿½åŠ 
        if çŠ¶æ³["H1ã‚¿ã‚°æ•°"] == 0:
            # è¨˜äº‹ã®æœ€åˆã«H1ã‚¿ã‚°ã‚’è¿½åŠ 
            h1ã‚¿ã‚° = f'<h1>{è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«}</h1>'
            
            # æœ€åˆã®pã‚¿ã‚°ã¾ãŸã¯h2ã‚¿ã‚°ã®å‰ã«H1ã‚’æŒ¿å…¥
            if '<p>' in æ›´æ–°æ¸ˆã¿å†…å®¹:
                æ›´æ–°æ¸ˆã¿å†…å®¹ = æ›´æ–°æ¸ˆã¿å†…å®¹.replace('<p>', f'{h1ã‚¿ã‚°}\n<p>', 1)
                å¤‰æ›´ãƒ•ãƒ©ã‚° = True
                print(f"   âœ… H1ã‚¿ã‚°è¿½åŠ : {è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«[:40]}...")
            elif '<h2' in æ›´æ–°æ¸ˆã¿å†…å®¹:
                æ›´æ–°æ¸ˆã¿å†…å®¹ = re.sub(r'(<h2[^>]*>)', f'{h1ã‚¿ã‚°}\n\\1', æ›´æ–°æ¸ˆã¿å†…å®¹, count=1)
                å¤‰æ›´ãƒ•ãƒ©ã‚° = True
                print(f"   âœ… H1ã‚¿ã‚°è¿½åŠ : {è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«[:40]}...")
        
        # è¤‡æ•°ã®H1ã‚¿ã‚°ãŒã‚ã‚‹å ´åˆã¯æœ€åˆä»¥å¤–ã‚’H2ã«å¤‰æ›
        elif çŠ¶æ³["H1ã‚¿ã‚°æ•°"] > 1:
            h1_count = 0
            def h1_replacer(match):
                nonlocal h1_count
                h1_count += 1
                if h1_count == 1:
                    return match.group(0)  # æœ€åˆã®H1ã¯ãã®ã¾ã¾
                else:
                    # 2ç•ªç›®ä»¥é™ã®H1ã‚’H2ã«å¤‰æ›
                    content = match.group(1)
                    return f'<h2>{content}</h2>'
            
            æ›´æ–°æ¸ˆã¿å†…å®¹ = re.sub(r'<h1[^>]*>(.*?)</h1>', h1_replacer, æ›´æ–°æ¸ˆã¿å†…å®¹, flags=re.IGNORECASE | re.DOTALL)
            å¤‰æ›´ãƒ•ãƒ©ã‚° = True
            print(f"   âœ… ä½™åˆ†ãªH1ã‚¿ã‚°ã‚’{çŠ¶æ³['H1ã‚¿ã‚°æ•°']-1}å€‹H2ã«å¤‰æ›")
        
        # å¤‰æ›´ãŒã‚ã£ãŸå ´åˆã®ã¿æ›´æ–°
        if å¤‰æ›´ãƒ•ãƒ©ã‚°:
            æ›´æ–°ãƒ‡ãƒ¼ã‚¿ = {'content': æ›´æ–°æ¸ˆã¿å†…å®¹}
            response = requests.post(f"{self.wp.api_url}/posts/{è¨˜äº‹ID}", 
                                   headers=self.wp.headers, 
                                   json=æ›´æ–°ãƒ‡ãƒ¼ã‚¿)
            
            if response.status_code == 200:
                print(f"   âœ… è¨˜äº‹ID {è¨˜äº‹ID}: H1ã‚¿ã‚°æœ€é©åŒ–å®Œäº†")
                return True
            else:
                print(f"   âŒ è¨˜äº‹ID {è¨˜äº‹ID}: æ›´æ–°å¤±æ•— ({response.status_code})")
                return False
        else:
            print(f"   â„¹ï¸ è¨˜äº‹ID {è¨˜äº‹ID}: H1ã‚¿ã‚°ã¯æ—¢ã«é©åˆ‡ã«è¨­å®šæ¸ˆã¿")
            return True
    
    def å…¨è¨˜äº‹H1ã‚¿ã‚°æœ€é©åŒ–(self):
        """å…¨è¨˜äº‹ã®H1ã‚¿ã‚°ã‚’æœ€é©åŒ–"""
        
        print("ğŸ·ï¸ å…¨è¨˜äº‹H1ã‚¿ã‚°æœ€é©åŒ–é–‹å§‹")
        print("=" * 60)
        
        # ç¾åœ¨ã®çŠ¶æ³ç¢ºèª
        print("ğŸ“Š ç¾åœ¨ã®H1ã‚¿ã‚°çŠ¶æ³:")
        for è¨˜äº‹ID in self.å¯¾è±¡è¨˜äº‹ãƒªã‚¹ãƒˆ:
            çŠ¶æ³ = self.H1ã‚¿ã‚°çŠ¶æ³ç¢ºèª(è¨˜äº‹ID)
            if çŠ¶æ³:
                print(f"è¨˜äº‹ID {è¨˜äº‹ID}: H1ã‚¿ã‚°{çŠ¶æ³['H1ã‚¿ã‚°æ•°']}å€‹")
                print(f"   {çŠ¶æ³['è¨˜äº‹ã‚¿ã‚¤ãƒˆãƒ«'][:40]}...")
        
        print("\n" + "-" * 60)
        
        # H1ã‚¿ã‚°æœ€é©åŒ–å®Ÿè¡Œ
        æˆåŠŸè¨˜äº‹æ•° = 0
        for è¨˜äº‹ID in self.å¯¾è±¡è¨˜äº‹ãƒªã‚¹ãƒˆ:
            æˆåŠŸ = self.H1ã‚¿ã‚°æœ€é©åŒ–(è¨˜äº‹ID)
            if æˆåŠŸ:
                æˆåŠŸè¨˜äº‹æ•° += 1
        
        print(f"\nğŸ¯ H1ã‚¿ã‚°æœ€é©åŒ–å®Œäº†!")
        print(f"å‡¦ç†è¨˜äº‹æ•°: {æˆåŠŸè¨˜äº‹æ•°}/{len(self.å¯¾è±¡è¨˜äº‹ãƒªã‚¹ãƒˆ)}")
        
        # æœ€é©åŒ–å¾Œã®çŠ¶æ³ç¢ºèª
        print("\nğŸ“Š æœ€é©åŒ–å¾Œã®H1ã‚¿ã‚°çŠ¶æ³:")
        for è¨˜äº‹ID in self.å¯¾è±¡è¨˜äº‹ãƒªã‚¹ãƒˆ:
            çŠ¶æ³ = self.H1ã‚¿ã‚°çŠ¶æ³ç¢ºèª(è¨˜äº‹ID)
            if çŠ¶æ³:
                print(f"è¨˜äº‹ID {è¨˜äº‹ID}: H1ã‚¿ã‚°{çŠ¶æ³['H1ã‚¿ã‚°æ•°']}å€‹")
                if çŠ¶æ³['H1ã‚¿ã‚°å†…å®¹']:
                    print(f"   å†…å®¹: {çŠ¶æ³['H1ã‚¿ã‚°å†…å®¹'][0][:40]}...")
        
        return æˆåŠŸè¨˜äº‹æ•°

if __name__ == "__main__":
    print("ğŸ·ï¸ H1ã‚¿ã‚°è‡ªå‹•è¨­å®šã‚·ã‚¹ãƒ†ãƒ ")
    print("=" * 60)
    
    H1ã‚·ã‚¹ãƒ†ãƒ  = H1ã‚¿ã‚°è‡ªå‹•è¨­å®šã‚·ã‚¹ãƒ†ãƒ ()
    H1ã‚·ã‚¹ãƒ†ãƒ .å…¨è¨˜äº‹H1ã‚¿ã‚°æœ€é©åŒ–()
    
    print("\nâœ… H1ã‚¿ã‚°è‡ªå‹•è¨­å®šã‚·ã‚¹ãƒ†ãƒ å®Œäº†")